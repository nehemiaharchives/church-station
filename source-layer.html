<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <link rel="apple-touch-icon" href="icon.png">

    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css" rel="stylesheet"/>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v0.10.1/mapbox-gl-language.js'></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        img {
            margin-top: 10px;
        }

        #title-text {
            text-align: center;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #menu {
            position: absolute;
            background: #000;
            color: #fff;
            padding: 10px 10px 20px 5px;
            opacity: 0.6;
            font-family: 'Open Sans', sans-serif;
            font-size: 13px;
        }

        ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .button {
            cursor: pointer;
            margin-top: 10px;
            margin-left: 10px;
        }

        .tooltip #tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: black;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;

            /* Position the tooltip */
            position: absolute;
            z-index: 1;
            top: 100px;
            left: 105%;
        }

        .tooltip:hover #tooltiptext {
            visibility: visible;
        }
    </style>

</head>

<body>
<div id="map"></div>
<div id="menu">

    <a href="https://www.christiantoday.co.jp">
        <img id="logo" src="https://www.christiantoday.co.jp/views/img/logo-small.png">
    </a>

    <h3>
        <div id="title-text"></div>
    </h3>

    <div class="tooltip">
        <ul>
            <li><input id="500" type="radio" name="rtoggle" value="streets" checked="checked"/>
                <label for="500">500m</label></li>

            <li><input id="1000" type="radio" name="rtoggle" value="light"/>
                <label for="1000">1000m</label></li>

            <li><input id="1500" type="radio" name="rtoggle" value="dark"/>
                <label for="1500">1500m</label></li>

            <li><input id="2000" type="radio" name="rtoggle" value="outdoors"/>
                <label for="2000">2000m</label></li>

            <li><input id="2500" type="radio" name="rtoggle" value="satellite"/>
                <label for="2500">2500m</label></li>

            <li><input id="3000" type="radio" name="rtoggle" value="satellite"/>
                <label for="3000">3000m</label></li>
        </ul>
        <span id="tooltiptext"></span>
    </div>

    <ul class="language" id="buttons">
        <li id='button-ja' class='button'>日本語</li>
        <li id='button-ko' class='button'>한국어</li>
        <li id='button-en' class='button'>English</li>
    </ul>
</div>

<script>
    var layerList = document.getElementById('menu');

    function detectBrowserLocale() {
        return navigator.languages ? navigator.languages[0] : (navigator.language || navigator.userLanguage);
    }

    function detectBrowserLanguage(browserLocale) {
        var language = browserLocale;
        var parts = language.split('-');
        var languageCode = language;
        if (parts.length > 1) {
            languageCode = parts[0];
        }
        if (['ar', 'en', 'es', 'fr', 'de', 'ja', 'ko', 'mul', 'pt', 'ru', 'zh'].indexOf(languageCode) > -1) {
            return languageCode;
        }
        return 'en';
    }

    function switchLanguage(languageToSwitch) {
        var titleText = document.getElementById('title-text');
        var logo = document.getElementById('logo');
        var toolTip = document.getElementById('tooltiptext');

        switch (languageToSwitch) {
            case 'ja':
                titleText.innerText = "教会と駅";
                logo.setAttribute("title", "クリスチャントゥデイ");
                document.title = "教会と駅 : インフォグラフィックス : クリスチャントゥデイ";
                toolTip.innerText = "１日あたり乗降者数１０００人以上で、教会が指定した範囲にない駅を青の四角柱で、ある駅をオレンジの四角柱で表示しています。四角柱の高さは乗降者数を表しています。";
                break;
            case 'ko':
                titleText.innerText = "교회와역";
                logo.setAttribute("title", "일본크리스천투데이");
                document.title = "교회와역 : 인포그래픽 : 일본크리스천투데이"
                toolTip.innerText = "하루 승강 자수 1000 명 이상 교회가 지정한 범위에없는 역을 파란색 사각형 기둥에있는 역 오렌지색 직사각형 기둥으로 표시하고 있습니다. 사각 기둥의 높이가 승강 인원을 나타냅니다.";
                break;
            case 'en':
                titleText.innerHTML = "Church<br><span>&</span><br>Station"
                logo.setAttribute("title", "Christian Today Japan");
                document.title = "Churches and Stations : Infographics : Christian Today Japan"
                toolTip.innerText = "Stations with more than 1000 passengers per day without church(es) in the specified distance are represented as blue square pillars, stations with churches are in orange. Heights are the number of passengers.";
                break;
        }
    }

    var browserLocale = detectBrowserLocale();
    var labels = layerList.getElementsByTagName("label");

    if (browserLocale === "en-US") {
        console.log("browser locale is en-US");
        for (var i = 0; i < labels.length; i++) {
            let inMeters = labels[i].getAttribute("for");
            let inMiles = inMeters * 0.000621371;
            labels[i].innerText =  inMiles.toFixed(2) + "mi";
        }
    }

    var browserLanguage = detectBrowserLanguage(browserLocale);
    console.log("browser language is " + browserLanguage);

    switchLanguage(browserLanguage);

    mapboxgl.accessToken = 'pk.eyJ1IjoibmVoZW1pYWhhcmNoaXZlIiwiYSI6ImNramp6OXN2bDF0OGgyeHRnMjB6ZmdianYifQ.ixrqFAV8JKIMyO5Pz8cvJw';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v9',
        center: [138, 36],
        zoom: 5.5,
        pitch: 60,
        bearing: -40,
        antialias: true,
        attributionControl: false
    });

    var mapboxLanguage = new MapboxLanguage();
    map.addControl(mapboxLanguage);

    var distanceToHide = "NOT_SELECTED";

    const base_url = 'https://raw.githubusercontent.com/nehemiaharchives/cpsd/master/data/japan/';

    map.on('load', function () {

        map.addControl(new mapboxgl.AttributionControl({
            compact: false,
            customAttribution: ["<a href=\"https://www.christiantoday.co.jp/\">© Christian Today Japan</a>"]
        }));

        map.addControl(new mapboxgl.NavigationControl());

        map.addSource('all-church', {
            'type': 'geojson',
            'data': `${base_url}all-church.json`
        });
        map.addLayer({
            'id': 'all-church',
            'type': 'circle',
            'source': 'all-church',
            'paint': {
                'circle-color': '#f89c2a',
                'circle-radius': 3,
                'circle-opacity': 0.4
            }
        });

        map.addSource("mapbox-transit", {
            "url": "mapbox://mapbox.transit-v2",
            "type": "vector"
        });
        map.addLayer({
            "id": "transit_line_line",
            "source": "mapbox-transit",
            "source-layer": "transit_line",
            "type": "line",
            "filter": [
                "==",
                "$type",
                "LineString"
            ],
            "paint": {
                "line-width": 2,
                "line-color": "rgba(66,100,251, 0.3)"
            }
        });

        setChurchStation(500);

    });

    function setChurchStation(distanceToShow) {

        if (map.getLayer("500-station-polygon-without-church") === undefined) {
            console.log("default layer not found, nothing to un-hide, initial loading");
            fetchGeoJson(500);
            distanceToHide = 500;
        } else {

            hideLayer(distanceToHide);

            console.log("500 found, already initiated, checking if distanceToShow already loaded");

            if (map.getLayer(`${distanceToShow}-station-polygon-without-church`) === undefined) {
                console.log(distanceToShow + " was not loaded yet, loading");
                fetchGeoJson(distanceToShow);
            } else {
                console.log(distanceToShow + " was already loaded, showing");
                showLayer(distanceToShow);
            }

            distanceToHide = distanceToShow;
        }
    }

    function fetchGeoJson(distance) {

        //500-station-polygon-without-church.json
        map.addSource(`${distance}-station-polygon-without-church`, {
            'type': 'geojson',
            'data': `${base_url}${distance}-station-polygon-without-church.json`
        });
        map.addLayer({
            'id': `${distance}-station-polygon-without-church`,
            'type': 'fill-extrusion',
            'source': `${distance}-station-polygon-without-church`,
            'paint': {
                'fill-extrusion-color': "#53d8fd",
                'fill-extrusion-height': ["*", ["sqrt", ['get', 'passengers']], 10],
                'fill-extrusion-opacity': 0.53
            }
        });

        //500-station-polygon-with-church.json
        map.addSource(`${distance}-station-polygon-with-church`, {
            'type': 'geojson',
            'data': `${base_url}${distance}-station-polygon-with-church.json`
        })
        map.addLayer({
            'id': `${distance}-station-polygon-with-church`,
            'type': 'fill-extrusion',
            'source': `${distance}-station-polygon-with-church`,
            'paint': {
                'fill-extrusion-color': "#fd853a",
                'fill-extrusion-height': ["*", ["sqrt", ['get', 'passengers']], 10],
                'fill-extrusion-opacity': 0.53
            }
        })

        //500-route.json
        map.addSource(`${distance}-route`, {
            'type': 'geojson',
            'data': `${base_url}${distance}-route.json`
        });
        map.addLayer({
            'id': `${distance}-route`,
            'type': 'line',
            'source': `${distance}-route`,
            'paint': {
                'line-color': '#fc8b45',
                'line-width': 2,
                'line-opacity': 0.58
            }
        });

        //500-church.json
        map.addSource(`${distance}-church`, {
            'type': 'geojson',
            'data': `${base_url}${distance}-church.json`
        });
        map.addLayer({
            'id': `${distance}-church`,
            'type': 'circle',
            'source': `${distance}-church`,
            'paint': {
                'circle-color': '#f89c2a',
                'circle-radius': 3,
                'circle-opacity': 0.5
            }
        });

        //500-station-point-without-church.json
        map.addSource(`${distance}-station-point-without-church`, {
            'type': 'geojson',
            'data': `${base_url}${distance}-station-point-without-church.json`
        });
        map.addLayer({
            'id': `${distance}-station-point-without-church`,
            'type': 'circle',
            'source': `${distance}-station-point-without-church`,
            'paint': {
                'circle-color': '#425bfa',
                'circle-radius': 3,
                'circle-opacity': 0.4
            }
        })
    }

    const layerPostFixList = [
        '-station-point-without-church',
        '-church',
        '-route',
        '-station-polygon-with-church',
        '-station-polygon-without-church'
    ];

    function hideLayer(distanceToHide) {
        layerPostFixList.forEach(postFix => {
            map.setLayoutProperty(`${distanceToHide}${postFix}`, 'visibility', 'none');
        });
    }

    function showLayer(distanceToShow) {
        layerPostFixList.forEach(postFix => {
            map.setLayoutProperty(`${distanceToShow}${postFix}`, 'visibility', 'visible');
        });
    }

    function switchLayer(layer) {
        var layerId = layer.target.id;
        console.log("calling setChurchStation with " + layerId);
        setChurchStation(layerId);
    }

    var inputs = layerList.getElementsByTagName('input');

    for (var i = 0; i < inputs.length; i++) {
        inputs[i].onclick = switchLayer;
    }

    document.getElementById('buttons').addEventListener('click', function (event) {
        var language = event.target.id.substr('button-'.length);
        map.setStyle(mapboxLanguage.setLanguage(map.getStyle(), language));
        switchLanguage(language);
    });

</script>

<!-- Google Analytics: change UA-XXXXX-Y to be your site's ID. -->
<script>
    window.ga = function () {
        ga.q.push(arguments)
    };
    ga.q = [];
    ga.l = +new Date;
    ga('create', 'UA-XXXXX-Y', 'auto');
    ga('set', 'anonymizeIp', true);
    ga('set', 'transport', 'beacon');
    ga('send', 'pageview')
</script>
<script src="https://www.google-analytics.com/analytics.js" async></script>
</body>

</html>
